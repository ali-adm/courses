# Небольшой справочник по командам Docker

## Оглавление
- [Небольшой справочник по командам Docker](#небольшой-справочник-по-командам-docker)
  - [Оглавление](#оглавление)
  - [Установка Docker](#установка-docker)
      - [Linux](#linux)
      - [Mac](#mac)
      - [Windows](#windows)
  - [Реестры и репозитории Docker](#реестры-и-репозитории-docker)
      - [Вход в реестр](#вход-в-реестр)
      - [Выход из реестра](#выход-из-реестра)
      - [Поиск образа](#поиск-образа)
      - [Pull (выгрузка из реестра) образа](#pull-выгрузка-из-реестра-образа)
      - [Push (загрузка в реестр) образа](#push-загрузка-в-реестр-образа)
  - [Первые действия с контейнерами](#первые-действия-с-контейнерами)
      - [Создание контейнера](#создание-контейнера)
      - [Первый запуск контейнера](#первый-запуск-контейнера)
      - [Переименование контейнера](#переименование-контейнера)
      - [Удаление контейнера](#удаление-контейнера)
      - [Обновление контейнера](#обновление-контейнера)
  - [Запуск и остановка контейнеров](#запуск-и-остановка-контейнеров)
      - [Запуск остановленного контейнера](#запуск-остановленного-контейнера)
      - [Остановка](#остановка)
      - [Перезагрузка](#перезагрузка)
      - [Пауза (приостановка всех процессов контейнера)](#пауза-приостановка-всех-процессов-контейнера)
      - [Снятие паузы](#снятие-паузы)
      - [Блокировка (до остановки контейнера)](#блокировка-до-остановки-контейнера)
      - [Отправка SIGKILL (завершающего сигнала)](#отправка-sigkill-завершающего-сигнала)
      - [Отправка другого сигнала](#отправка-другого-сигнала)
      - [Подключение к существующему контейнеру](#подключение-к-существующему-контейнеру)
  - [Получение информации о контейнерах](#получение-информации-о-контейнерах)
      - [Работающие контейнеры](#работающие-контейнеры)
      - [Логи контейнера](#логи-контейнера)
      - [Информация о контейнере](#информация-о-контейнере)
      - [События контейнера](#события-контейнера)
      - [Публичные порты](#публичные-порты)
      - [Выполняющиеся процессы](#выполняющиеся-процессы)
      - [Использование ресурсов](#использование-ресурсов)
      - [Изменения в файлах или директориях файловой системы контейнера](#изменения-в-файлах-или-директориях-файловой-системы-контейнера)
  - [Управление образами](#управление-образами)
      - [Список образов](#список-образов)
      - [Создание образов](#создание-образов)
      - [Удаление образа](#удаление-образа)
      - [Загрузка репозитория в tar (из файла или стандартного ввода)](#загрузка-репозитория-в-tar-из-файла-или-стандартного-ввода)
      - [Сохранение образа в tar-архив](#сохранение-образа-в-tar-архив)
      - [Просмотр истории образа](#просмотр-истории-образа)
      - [Создание образа из контейнера](#создание-образа-из-контейнера)
      - [Тегирование образа](#тегирование-образа)
      - [Push (загрузка в реестр) образа](#push-загрузка-в-реестр-образа-1)
  - [Сеть](#сеть)
      - [Создание сети](#создание-сети)
      - [Удаление сети](#удаление-сети)
      - [Список сетей](#список-сетей)
      - [Получение информации о сети](#получение-информации-о-сети)
      - [Подключение работающего контейнера к сети](#подключение-работающего-контейнера-к-сети)
      - [Подключение контейнера к сети при его запуске](#подключение-контейнера-к-сети-при-его-запуске)
      - [Отключение контейнера от сети](#отключение-контейнера-от-сети)
  - [Очистка Docker](#очистка-docker)
      - [Удаление работающего контейнера](#удаление-работающего-контейнера)
      - [Удаление контейнера и его тома (volume)](#удаление-контейнера-и-его-тома-volume)
      - [Удаление всех контейнеров со статусом exited](#удаление-всех-контейнеров-со-статусом-exited)
      - [Удаление всех остановленных контейнеров](#удаление-всех-остановленных-контейнеров)
      - [Удаление контейнеров, остановленных более суток назад](#удаление-контейнеров-остановленных-более-суток-назад)
      - [Удаление образа](#удаление-образа-1)
      - [Удаление неиспользуемых (dangling) образов](#удаление-неиспользуемых-dangling-образов)
      - [Удаление неиспользуемых (dangling) образов даже с тегами](#удаление-неиспользуемых-dangling-образов-даже-с-тегами)
      - [Удаление всех образов](#удаление-всех-образов)
      - [Удаление всех образов без тегов](#удаление-всех-образов-без-тегов)
      - [Остановка и удаление всех контейнеров](#остановка-и-удаление-всех-контейнеров)
      - [Удаление неиспользуемых (dangling) томов](#удаление-неиспользуемых-dangling-томов)
      - [Удаление неиспользуемых (dangling) томов по фильтру](#удаление-неиспользуемых-dangling-томов-по-фильтру)
      - [Удаление неиспользуемых сетей](#удаление-неиспользуемых-сетей)
      - [Удаление всех неиспользуемых объектов](#удаление-всех-неиспользуемых-объектов)
      - [По умолчанию для Docker 17.06.1+ тома не удаляются. Чтобы удалились и они тоже:](#по-умолчанию-для-docker-17061-тома-не-удаляются-чтобы-удалились-и-они-тоже)
  - [Docker Swarm](#docker-swarm)
      - [Установка Docker Swarm](#установка-docker-swarm)
      - [Инициализация Swarm](#инициализация-swarm)
      - [Подключение рабочего узла (worker) к Swarm](#подключение-рабочего-узла-worker-к-swarm)
      - [Подключение управляющего узла (manager) к Swarm](#подключение-управляющего-узла-manager-к-swarm)
      - [Список сервисов](#список-сервисов)
      - [Список узлов](#список-узлов)
      - [Создание сервиса](#создание-сервиса)
      - [Список заданий Swarm](#список-заданий-swarm)
      - [Масштабирование сервиса](#масштабирование-сервиса)
      - [Обновление сервиса](#обновление-сервиса)
  - [Упражнения.](#упражнения)



> Прим. перев.: *Aymen El Amri*, руководящий компанией *Eralabs* и создавший обучающий курс «Безболезненный Docker», опубликовал свой *Docker Cheat Sheet* — шпаргалку по основным командам Docker. Git-репозиторий этого документа на GitHub уже набрал 1000+ stars и несколько сторонних контрибьюторов, что подтвердило его актуальность и пользу.

Представленные здесь команды описаны минимально (с акцентом на читаемость как есть) и включают в себя установку Docker, работу с реестрами и репозиториями, контейнерами, образами, сетью, Docker Swarm. Ниже представлен перевод шпаргалки в её состоянии на 2 сентября 2023 года, с дополнениями из комментариев ниже.

## Установка Docker
#### Linux
```bash
curl -sSL https://get.docker.com/ | sh
```

#### Mac  
Скачайте dmg по этой ссылке:
```bash
https://download.docker.com/mac/stable/Docker.dmg
```

#### Windows  
Используйте MSI-инсталлятор:
```bash
https://download.docker.com/win/stable/InstallDocker.msi
```

[Назад к оглавлению](#оглавление)


## Реестры и репозитории Docker
#### Вход в реестр
```bash
docker login
docker login localhost:8080
```
#### Выход из реестра
```bash
docker logout
docker logout localhost:8080
```

#### Поиск образа
```bash
docker search nginx
docker search nginx -- filter stars=3 --no-trunc busybox
```

#### Pull (выгрузка из реестра) образа
```bash
docker pull nginx
docker pull eon01/nginx localhost:5000/myadmin/nginx
```

#### Push (загрузка в реестр) образа
```bash
docker push eon01/nginx
docker push eon01/nginx localhost:5000/myadmin/nginx
```


[Назад к оглавлению](#оглавление)

## Первые действия с контейнерами

#### Создание контейнера
```bash
docker create -t -i eon01/infinite --name infinite
```

#### Первый запуск контейнера
```bash
docker run -it --name infinite -d eon01/infinite
```

#### Переименование контейнера
```bash
docker rename infinite infinity
```

#### Удаление контейнера
```bash
docker rm infinite
```

#### Обновление контейнера
```bash
docker update --cpu-shares 512 -m 300M infinite
```


[Назад к оглавлению](#оглавление)

## Запуск и остановка контейнеров
#### Запуск остановленного контейнера
```bash
docker start nginx
```

#### Остановка
```bash
docker stop nginx
```

#### Перезагрузка
```bash
docker restart nginx
```

#### Пауза (приостановка всех процессов контейнера)
```bash
docker pause nginx
```

#### Снятие паузы
```bash
docker unpause nginx
```

#### Блокировка (до остановки контейнера)
```bash
docker wait nginx
```

#### Отправка SIGKILL (завершающего сигнала)
```bash
docker kill nginx
```

#### Отправка другого сигнала
```bash
docker kill -s HUP nginx
```

#### Подключение к существующему контейнеру
```bash
docker attach nginx
```

[Назад к оглавлению](#оглавление)


## Получение информации о контейнерах
#### Работающие контейнеры
```bash
docker ps
docker ps -a
```

#### Логи контейнера
```bash
docker logs infinite
```

#### Информация о контейнере
```bash
docker inspect infinite
docker inspect --format '{{ .NetworkSettings.IPAddress }}' $(docker ps -q)
```

#### События контейнера
```bash
docker events infinite
```

#### Публичные порты
```bash
docker port infinite
```

#### Выполняющиеся процессы
```bash
docker top infinite
```

#### Использование ресурсов
```bash
docker stats infinite
```

#### Изменения в файлах или директориях файловой системы контейнера
```bash
docker diff infinite
```


[Назад к оглавлению](#оглавление)

## Управление образами
#### Список образов
```bash
docker images
```

#### Создание образов
```bash
docker build .
docker build github.com/creack/docker-firefox
docker build - < Dockerfile
docker build - < context.tar.gz
docker build -t eon/infinite .
docker build -f myOtherDockerfile .
curl example.com/remote/Dockerfile | docker build -f - .
```

#### Удаление образа
```bash
docker rmi nginx
```

#### Загрузка репозитория в tar (из файла или стандартного ввода)
```bash
docker load < ubuntu.tar.gz
docker load --input ubuntu.tar
```

#### Сохранение образа в tar-архив
```bash
docker save busybox > ubuntu.tar
```

#### Просмотр истории образа
```bash
docker history
```

#### Создание образа из контейнера
```bash
docker commit nginx
```

#### Тегирование образа
```bash
docker tag nginx eon01/nginx
```

#### Push (загрузка в реестр) образа
```bash
docker push eon01/nginx
```


[Назад к оглавлению](#оглавление)

## Сеть
#### Создание сети
```bash
docker network create -d overlay MyOverlayNetwork
docker network create -d bridge MyBridgeNetwork
docker network create -d overlay \
  --subnet=192.168.0.0/16 \
  --subnet=192.170.0.0/16 \
  --gateway=192.168.0.100 \
  --gateway=192.170.0.100 \
  --ip-range=192.168.1.0/24 \
  --aux-address="my-router=192.168.1.5" --aux-address="my-switch=192.168.1.6" \
  --aux-address="my-printer=192.170.1.5" --aux-address="my-nas=192.170.1.6" \
  MyOverlayNetwork
```

#### Удаление сети
```bash
docker network rm MyOverlayNetwork
```

#### Список сетей
```bash
docker network ls
```

#### Получение информации о сети
```bash
docker network inspect MyOverlayNetwork
```

#### Подключение работающего контейнера к сети
```bash
docker network connect MyOverlayNetwork nginx
```

#### Подключение контейнера к сети при его запуске
```bash
docker run -it -d --network=MyOverlayNetwork nginx
```

#### Отключение контейнера от сети
```bash
docker network disconnect MyOverlayNetwork nginx
```


[Назад к оглавлению](#оглавление)

## Очистка Docker
#### Удаление работающего контейнера
```bash
docker rm nginx
```

#### Удаление контейнера и его тома (volume)
```bash
docker rm -v nginx
```

#### Удаление всех контейнеров со статусом exited
```bash
docker rm $(docker ps -a -f status=exited -q)
```

#### Удаление всех остановленных контейнеров
```bash
docker container prune
docker rm `docker ps -a -q`
```

#### Удаление контейнеров, остановленных более суток назад
```bash
docker container prune --filter "until=24h"
```

#### Удаление образа
```bash
docker rmi nginx
```

#### Удаление неиспользуемых (dangling) образов
```bash
docker image prune
docker rmi $(docker images -f dangling=true -q)
```

#### Удаление неиспользуемых (dangling) образов даже с тегами
```bash
docker image prune -a
```

#### Удаление всех образов
```bash
docker rmi $(docker images -a -q)
```

#### Удаление всех образов без тегов
```bash
docker rmi -f $(docker images | grep "^<none>" | awk "{print $3}")
```

#### Остановка и удаление всех контейнеров
```bash
docker stop $(docker ps -a -q) && docker rm $(docker ps -a -q)
```

#### Удаление неиспользуемых (dangling) томов

```bash
docker volume prune
docker volume rm $(docker volume ls -f dangling=true -q)
```

#### Удаление неиспользуемых (dangling) томов по фильтру
```bash
docker volume prune --filter "label!=keep"
```

#### Удаление неиспользуемых сетей
```bash
docker network prune
```

#### Удаление всех неиспользуемых объектов
```bash
docker system prune
```

#### По умолчанию для Docker 17.06.1+ тома не удаляются. Чтобы удалились и они тоже:
```bash
docker system prune --volumes
```


[Назад к оглавлению](#оглавление)

## Docker Swarm
#### Установка Docker Swarm
```bash
curl -ssl https://get.docker.com | bash
```

> Прим. перев.: в Docker версий 1.12.0+ ничего дополнительно устанавливать не требуется, т.к. Docker Swarm встроен в Docker Engine в виде специального режима (Swarm mode).

#### Инициализация Swarm
```bash
docker swarm init --advertise-addr 192.168.10.1
```

#### Подключение рабочего узла (worker) к Swarm
```bash
docker swarm join-token worker
```

#### Подключение управляющего узла (manager) к Swarm
```bash
docker swarm join-token manager
```

#### Список сервисов
```bash
docker service ls
```

#### Список узлов
```bash
docker node ls
```

#### Создание сервиса
```bash
docker service create --name vote -p 8080:80 instavote/vote
```

#### Список заданий Swarm
```bash
docker service ps
```

#### Масштабирование сервиса
```bash
docker service scale vote=3
```

#### Обновление сервиса
```bash
docker service update --image instavote/vote:movies vote
docker service update --force --update-parallelism 1 --update-delay 30s nginx
docker service update --update-parallelism 5--update-delay 2s --image instavote/vote:indent vote
docker service update --limit-cpu 2 nginx
docker service update --replicas=5 nginx
```

> **P.S.**
> Прим. перев.: Напомню, что оригинальная (англоязычная) версия Docker Cheat Sheet доступна и обновляется в Git-репозитории (https://github.com/eon01/DockerCheatSheet). Автор будет рад исправлениям/пополнениям от сообщества.

[Назад к оглавлению](#оглавление)


## Упражнения. 
Автор проводит тренинги и внутреннее обучение в командах. Обычно рекомендуются такие упражнения:

*Установите Docker* на рабочий компьютер.  
  
Возьмите готовый *Docker image* с *Docker Hub* с *базой данных* и запустите на его основе контейнер. Это можно сделать по инструкции, которую производитель *image* выкладывает на *Docker Hub*. Затем подключитесь к запущенной БД каким-нибудь клиентом и убедитесь, что всё работает.  

Напишите простенький сервис *REST API* и *Docker-файл* для упаковки сервиса в образ, подглядывая в референсы или книгу. Ваша задача — *разобраться в теории, получить Docker image и проставить теги*.

Из полученного ранее образа *создайте и запустите контейнер*. Вам придётся разобраться с: 

- параметрами команды `Docker run`, 
- настройками портов, 
- передачей переменных окружению, 
- монтированием и основными параметрами. 
- Также стоит научиться подключаться к контейнеру, 
- выполнять `bash-команды` и смотреть логи приложения.

Усложните тестовый сервис, научив его работать с базой данных. Затем разверните контейнеры с сервисом и базой данных и соедините их внутренней сетью. Простое и в то же время очень полезное упражнение, на котором *очень часто возникают затруднения на собеседованиях*.

Переходим к *Docker Compose*. Посмотрите, как написать `YAML` и создать *группу контейнеров*, как соединять их в сеть и работать с маунтами.

*Опубликуйте* свой *Docker image* в *Docker Hub*.
  
На одном аккаунте можно бесплатно публиковать только один образ, но есть **GitLab**, где *нет таких ограничений*. Правда, он устроен немного сложнее, новичок может запутаться. Ещё в том же **GitLab** можно создать *приватный registry-режим* и публиковать проекты **без ограничений**.

## Оглавление:

- [Оглавление:](#оглавление)
- [Как убрать запрос пароля](#как-убрать-запрос-пароля)
- [Как работает сеть в WSL?](#как-работает-сеть-в-wsl)
- [Как настроить сеть в WSL2?](#как-настроить-сеть-в-wsl2)
- [Как сменить IP-адрес в WSL2](#как-сменить-ip-адрес-в-wsl2)
- [Обновление WSL](#обновление-wsl)

## **Как убрать запрос пароля:**
1. **Создай файл `~/.hushlogin`** (если ещё не создан):
   ```bash
   touch ~/.hushlogin
   ```
   Это убирает приветственное сообщение, но **не отключает запрос пароля**.

2. **Настрой автовход:**
   - WSL2 не поддерживает автовход "из коробки", но можно обойти это:
   - Открой файл `~/.bashrc`:
     ```bash
     nano ~/.bashrc
     ```
   - Добавь в конец:
     ```bash
     if [ -z "$(whoami)" ]; then
       echo "your_password" | sudo -S -k bash -c "echo 'Автовход выполнен'"
     fi
     ```
     Замени `your_password` на свой пароль.

3. **Используй `wsl.exe` с параметрами**:
   - В Windows создай ярлык для запуска WSL без пароля:
     ```powershell
     wsl.exe -u root
     ```
     Это запустит WSL от имени root без запроса пароля.

---

### **Важно:**
- Хранение пароля в открытом виде (как в `.bashrc`) **небезопасно**. Используй это только для тестовых сред.
- Если нужно больше безопасности, настрой SSH-ключи для авторизации.

---

### **Итог:**
- `.hushlogin` — только для скрытия приветствия.
- Для автовхода используй `.bashrc` или запуск WSL от root.

Отлично, дружище! Сейчас разберёмся с сетью в WSL. Это важная тема, особенно если тебе нужно настроить доступ к Ubuntu по сети или сделать статический IP. Давай начнём с теории, а потом перейдём к практике.

[Назад к оглавлению](#оглавление)

---

## **Как работает сеть в WSL?**

### **1. WSL1 vs WSL2: Разница в сети**
- **WSL1**:
  - Использует общую сетевую подсистему Windows.
  - WSL и Windows используют один и тот же сетевой стек.
  - IP-адрес WSL совпадает с IP-адресом Windows.

- **WSL2**:
  - Работает на основе виртуальной машины (Hyper-V).
  - WSL2 имеет свой собственный виртуальный сетевой интерфейс и DHCP-сервер.
  - WSL2 получает IP-адрес из внутренней подсети (обычно `172.x.x.x`).
  - Windows и WSL2 взаимодействуют через виртуальный сетевой мост.

---

### **2. Как WSL2 взаимодействует с сетью?**
- **Доступ из WSL2 в Windows**:
  - WSL2 может обращаться к Windows через специальный IP-адрес, который прописан в `/etc/resolv.conf` (обычно это `nameserver 172.x.x.1`).
  - Например, если на Windows запущен сервер на порту 3000, WSL2 может обратиться к нему по адресу `172.x.x.1:3000`.

- **Доступ из Windows в WSL2**:
  - WSL2 имеет динамический IP-адрес, который меняется при перезапуске.
  - Чтобы получить доступ к WSL2 из Windows, нужно пробросить порты или использовать статический IP.

---

### **3. Проблемы с сетью в WSL2**
- **Динамический IP**: IP-адрес WSL2 меняется после перезапуска.
- **NAT**: WSL2 использует NAT, поэтому порты WSL2 не доступны извне (например, из локальной сети) без дополнительной настройки.

[Назад к оглавлению](#оглавление)

---

## **Как настроить сеть в WSL2?**

### **1. Получить текущий IP-адрес WSL2**
Внутри WSL выполни команду:
```bash
ip addr show eth0
```
Или просто:
```bash
hostname -I
```
Ты увидишь IP-адрес в подсети `172.x.x.x`.

---

### **2. Доступ к WSL2 из Windows**
Чтобы получить доступ к WSL2 из Windows, используй IP-адрес, который ты получил выше. Например, если в WSL2 запущен веб-сервер на порту 80, открой в браузере Windows:
```
http://172.x.x.x:80
```

---

### **3. Проброс портов из WSL2 в Windows**
Если ты хочешь, чтобы порты WSL2 были доступны из локальной сети, нужно пробросить порты через Windows. Например, для порта 80:

1. Узнай IP-адрес WSL2:
   ```bash
   hostname -I
   ```

2. На Windows выполни команду в PowerShell (администратор):
   ```powershell
   netsh interface portproxy add v4tov4 listenport=80 listenaddress=0.0.0.0 connectport=80 connectaddress=(IP_WSL2)
   ```
   Например:
   ```powershell
   netsh interface portproxy add v4tov4 listenport=80 listenaddress=0.0.0.0 connectport=80 connectaddress=172.28.112.1
   ```

3. Разреши порт в брандмауэре Windows:
   ```powershell
   New-NetFirewallRule -DisplayName "WSL2 Port 80" -Direction Inbound -Action Allow -Protocol TCP -LocalPort 80
   ```

Теперь порт 80 WSL2 будет доступен из локальной сети через IP-адрес Windows.

---

### **4. Статический IP в WSL2**
WSL2 не поддерживает статический IP "из коробки", но можно настроить его вручную. Вот как это сделать:

#### **Вариант 1: Использование скрипта для настройки статического IP**
1. Создай скрипт в WSL2, например, `/usr/local/bin/wsl-static-ip.sh`:
   ```bash
   sudo nano /usr/local/bin/wsl-static-ip.sh
   ```

2. Добавь следующий код:
   ```bash
   #!/bin/bash
   sudo ip addr add 192.168.50.2/24 dev eth0
   sudo ip route add default via 192.168.50.1 dev eth0
   echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
   ```

3. Сделай скрипт исполняемым:
   ```bash
   sudo chmod +x /usr/local/bin/wsl-static-ip.sh
   ```

4. Добавь скрипт в автозагрузку:
   Открой файл `~/.bashrc` и добавь строку:
   ```bash
   /usr/local/bin/wsl-static-ip.sh
   ```

#### **Вариант 2: Использование `wsl.conf`**
1. Создай или отредактируй файл `/etc/wsl.conf`:
   ```bash
   sudo nano /etc/wsl.conf
   ```

2. Добавь следующие строки:
   ```ini
   [network]
   generateResolvConf = false
   ```

3. Перезапусти WSL:
   ```powershell
   wsl --shutdown
   ```

---

### **5. Доступ к WSL2 из локальной сети**
Чтобы WSL2 был доступен из локальной сети, нужно:
1. Пробросить порты (как описано выше).
2. Настроить брандмауэр Windows.
3. Убедиться, что WSL2 и Windows находятся в одной сети.

---

### **6. Полезные команды**
- **Проверка сети в WSL2**:
  ```bash
  ping google.com
  ```
- **Проверка открытых портов**:
  ```bash
  sudo netstat -tuln
  ```
- **Перезапуск сети WSL2**:
  ```powershell
  wsl --shutdown
  ```
---

Поменять IP-адрес в WSL2 можно вручную, но важно понимать, что WSL2 использует динамическую настройку сети через DHCP, и изменения могут быть сброшены после перезапуска WSL. Однако, если тебе нужно временно изменить IP-адрес или настроить его вручную, вот как это сделать:

[Назад к оглавлению](#оглавление)

---

## **Как сменить IP-адрес в WSL2**

### **1. Временное изменение IP-адреса**
Ты можешь вручную назначить IP-адрес интерфейсу `eth0` в WSL2. Это изменение будет действовать до перезапуска WSL.

1. Узнай текущий IP-адрес:
   ```bash
   ip addr show eth0
   ```

2. Удали текущий IP-адрес:
   ```bash
   sudo ip addr del <текущий_IP>/24 dev eth0
   ```
   Например:
   ```bash
   sudo ip addr del 172.28.112.1/24 dev eth0
   ```

3. Назначь новый IP-адрес:
   ```bash
   sudo ip addr add <новый_IP>/24 dev eth0
   ```
   Например:
   ```bash
   sudo ip addr add 192.168.50.2/24 dev eth0
   ```

4. Проверь изменения:
   ```bash
   ip addr show eth0
   ```

---

### **2. Настройка статического IP через скрипт**
Чтобы IP-адрес автоматически назначался при запуске WSL, можно создать скрипт, который будет выполняться при старте WSL.

1. Создай скрипт, например, `/usr/local/bin/set-static-ip.sh`:
   ```bash
   sudo nano /usr/local/bin/set-static-ip.sh
   ```

2. Добавь в него следующий код:
   ```bash
   #!/bin/bash
   sudo ip addr add 192.168.50.2/24 dev eth0
   sudo ip route add default via 192.168.50.1 dev eth0
   echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
   ```

3. Сделай скрипт исполняемым:
   ```bash
   sudo chmod +x /usr/local/bin/set-static-ip.sh
   ```

4. Добавь скрипт в автозагрузку:
   Открой файл `~/.bashrc` и добавь строку:
   ```bash
   /usr/local/bin/set-static-ip.sh
   ```

Теперь при каждом запуске WSL скрипт будет назначать статический IP.

---

### **3. Использование `wsl.conf` для настройки сети**
Файл `wsl.conf` позволяет настроить некоторые параметры WSL, включая сеть. Однако, он не поддерживает прямое назначение IP-адреса. Вместо этого можно отключить автоматическую генерацию `resolv.conf`, чтобы управлять DNS вручную.

1. Создай или отредактируй файл `/etc/wsl.conf`:
   ```bash
   sudo nano /etc/wsl.conf
   ```

2. Добавь следующие строки:
   ```ini
   [network]
   generateResolvConf = false
   ```

3. Перезапусти WSL:
   ```powershell
   wsl --shutdown
   ```

4. Вручную настрой `resolv.conf`:
   ```bash
   echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
   ```

---

### **4. Проброс портов и доступ из Windows**
Если ты изменил IP-адрес WSL2, убедись, что порты проброшены правильно. Например, для проброса порта 80:

1. Узнай новый IP-адрес WSL2:
   ```bash
   hostname -I
   ```

2. На Windows выполни команду в PowerShell (администратор):
   ```powershell
   netsh interface portproxy add v4tov4 listenport=80 listenaddress=0.0.0.0 connectport=80 connectaddress=<новый_IP_WSL2>
   ```

3. Разреши порт в брандмауэре Windows:
   ```powershell
   New-NetFirewallRule -DisplayName "WSL2 Port 80" -Direction Inbound -Action Allow -Protocol TCP -LocalPort 80
   ```

---

### **5. Важные моменты**
- **Динамический IP**: WSL2 использует DHCP, поэтому IP-адрес может измениться после перезапуска.
- **NAT**: WSL2 работает через NAT, поэтому IP-адрес WSL2 недоступен из локальной сети без проброса портов.
- **Резервное копирование**: Если ты настраиваешь сеть вручную, сохраняй резервные копии конфигурационных файлов.

[Назад к оглавлению](#оглавление)

---

## **Обновление WSL**

Чтобы обновить Ubuntu в WSL до последней версии, нужно выполнить несколько шагов. Обновление включает в себя как обновление пакетов внутри самой Ubuntu, так и возможное обновление дистрибутива до более новой версии (например, с Ubuntu 20.04 до 22.04). Вот как это сделать:

---

### **1. Обновление пакетов внутри Ubuntu**
1. Запустите Ubuntu через WSL:
   ```powershell
   wsl -d Ubuntu-20.04
   ```

2. Обновите список пакетов и установите обновления:
   ```bash
   sudo apt update && sudo apt upgrade -y
   ```

3. (Опционально) Удалите ненужные пакеты:
   ```bash
   sudo apt autoremove -y
   ```

---

### **2. Обновление до новой версии Ubuntu (например, 22.04)**
Если ты хочешь перейти с Ubuntu 20.04 на более новую версию (например, 22.04), выполни следующие шаги:

1. Запусти Ubuntu:
   ```powershell
   wsl -d Ubuntu-20.04
   ```

2. Убедись, что установлен инструмент `do-release-upgrade`:
   ```bash
   sudo apt install update-manager-core -y
   ```

3. Запусти процесс обновления:
   ```bash
   sudo do-release-upgrade
   ```
   - Если новая версия доступна, процесс начнется автоматически.
   - Следуй инструкциям на экране (возможно, потребуется подтвердить замену конфигурационных файлов).

4. После завершения перезапусти WSL:
   ```powershell
   wsl --shutdown
   wsl -d Ubuntu-20.04
   ```

---

### **3. Если `do-release-upgrade` не предлагает обновление**
Иногда `do-release-upgrade` не предлагает обновление, если текущая версия ещё не достигла конца поддержки. В этом случае можно вручную изменить файл `/etc/update-manager/release-upgrades`:

1. Открой файл в редакторе:
   ```bash
   sudo nano /etc/update-manager/release-upgrades
   ```

2. Измени строку `Prompt=normal` на `Prompt=lts` (для обновления до LTS-версии):
   ```
   Prompt=lts
   ```

3. Сохрани изменения и повтори команду:
   ```bash
   sudo do-release-upgrade
   ```

---

### **4. Альтернативный способ: Установка новой версии Ubuntu**
Если обновление через `do-release-upgrade` не работает, можно установить новую версию Ubuntu параллельно с текущей:

1. Установи новую версию Ubuntu из Microsoft Store (например, Ubuntu 22.04).
2. После установки запусти новую версию:
   ```powershell
   wsl -d Ubuntu-22.04
   ```
3. (Опционально) Удали старую версию, если она больше не нужна:
   ```powershell
   wsl --unregister Ubuntu-20.04
   ```

---

### **5. Проверка версии Ubuntu**
После обновления проверь версию:
```bash
lsb_release -a
```
Пример вывода:
```
No LSB modules are available.
Distributor ID: Ubuntu
Description:    Ubuntu 22.04.1 LTS
Release:        22.04
Codename:       jammy
```

---

Если что-то пойдет не так, всегда можно сделать резервную копию текущего дистрибутива:
```powershell
wsl --export Ubuntu-20.04 ubuntu_backup.tar
```

[Назад к оглавлению](#оглавление)


---

## **Установка WSL на диск D:\\**

1. **Скачай дистрибутив вручную**:
   - Перейди по ссылке: [Ubuntu 24.04 LTS](https://aka.ms/wslubuntu2404).
   - Скачай файл `.appx` (например, `Ubuntu_2404.1.0.0_x64.appx`).

2. **Перемести файл на диск D:\**:
   - Создай папку `D:\VMs\wsl\`.
   - Перемести туда скачанный файл `.appx`.

3. **Установи дистрибутив**:
   - Открой PowerShell (администратор) и выполни:
     ```powershell
     cd D:\VMs\wsl\
     Add-AppxPackage .\Ubuntu_2404.1.0.0_x64.appx
     ```

4. **Запусти дистрибутив**:
   - Найди Ubuntu в меню «Пуск» и запусти.
   - Заверши установку (создай пользователя и пароль).

---

## **Перенос существующего дистрибутива на D:\\**

Если ты уже установил Ubuntu и хочешь перенести его на `D:\`, сделай так:

1. **Экспорт дистрибутива**:
   ```powershell
   wsl --export Ubuntu-24.04 D:\VMs\wsl\ubuntu-24.04.tar
   ```

2. **Удаление старого дистрибутива**:
   ```powershell
   wsl --unregister Ubuntu-24.04
   ```

3. **Импорт дистрибутива на D:\\**:
   ```powershell
   wsl --import Ubuntu-24.04 D:\VMs\wsl\ D:\VMs\wsl\ubuntu-24.04.tar --version 2
   ```

4. **Узнай имя пользователя**:  
Если ты не помнишь имя пользователя, которое создавал при установке Ubuntu, сделай так:

   Запусти WSL:
   ```powershell
   wsl -d Ubuntu-24.04
   ```

   Посмотри список пользователей:
   ```bash
   ls /home
   ```
   Там будет папка с именем твоего пользователя (например, `aliadm`).

5. **Если пользователя нет (переходи к следующему шагу если пользователь есть**:  
Если в WSL нет пользователя (например, ты его удалил), создай нового:

   5.1. Запусти WSL от root:
   ```powershell
   wsl -d Ubuntu-24.04 -u root
   ```

   5.2. Создай пользователя:
   ```bash
   adduser aliadm
   ```
   - Замени `aliadm` на желаемое имя пользователя.
   - Задай пароль и остальные данные (можно пропустить, нажимая Enter).

   5.3. Добавь пользователя в группу `sudo`:
   ```bash
   usermod -aG sudo aliadm
   ```

   5.4. Настрой пользователя по умолчанию.

6. **Настройка пользователя по умолчанию**:  
Файл `/etc/wsl.conf` нужен для настройки WSL. Вот как его правильно создать:

   6.1. Запусти WSL от root:
   ```powershell
   wsl -d Ubuntu-24.04 -u root
   ```

   6.2. Создай или отредактируй файл `/etc/wsl.conf`:
   ```bash
   nano /etc/wsl.conf
   ```

   6.3. Добавь следующие строки:
   ```ini
   [user]
   default=aliadm
   ```
   - Замени `aliadm` на имя твоего пользователя (которое ты узнал выше).

   6.4. Сохрани файл и выйди из редактора (`Ctrl + X`, затем `Y` и `Enter`).


7. **Проверка**
   7.1. Перезапусти WSL:
   ```powershell
   wsl --shutdown
   wsl -d Ubuntu-24.04
   ```

   7.2. Убедись, что WSL запускается от твоего пользователя:
   ```bash
   whoami
   ```
   Должно быть:
   ```
   aliadm
   ```

8. **Настройка дистрибутива по умолчанию**:  
   Если в системе присутствует несколько дистрибутивов wsl:

   8.1. Посмотри список дистрибутивов:
   ```bash
   wsl --list --verbose
   ```

   8.2. Установи дистрибутив по умолчанию:
   ```bash
   wsl --set-default Ubuntu-24.04
   ```

   8.3. Проверь:
   ```bash
   wsl -l -v
   Звёздочка (`*`) будет рядом с выбранным дистрибутивом.


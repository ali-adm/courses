# Настройка сети Netplan в Ubuntu


## Оглавление
- [Настройка сети Netplan в Ubuntu](#настройка-сети-netplan-в-ubuntu)
  - [Оглавление](#оглавление)
  - [Основы использования Netplan](#основы-использования-netplan)
  - [1. Синтаксис конфигурации Netplan](#1-синтаксис-конфигурации-netplan)
  - [2. Параметры Netplan](#2-параметры-netplan)
  - [3. Команды Netplan](#3-команды-netplan)
- [Как настроить сеть Netplan в Ubuntu](#как-настроить-сеть-netplan-в-ubuntu)
  - [1. Настройка динамического IP в Netplan](#1-настройка-динамического-ip-в-netplan)
  - [2. Настройка статического IP в Netplan](#2-настройка-статического-ip-в-netplan)
  - [3. Настройка маршрутов в Netplan](#3-настройка-маршрутов-в-netplan)
  - [4. Настройка Wi-Fi через Netplan на Ubuntu](#4-настройка-wi-fi-через-netplan-на-ubuntu)
  - [5. Применение конфигурации netplan](#5-применение-конфигурации-netplan)
- [Выводы](#выводы)



Начиная с релиза Ubuntu 17.10, для управления конфигурацией сети используется утилита *Netplan*. Раньше для этих целей применялся скрипт *ifupdown*, конфигурационные файлы которого находились в папке `/etc/network/interfaces`. Недостатком такого подхода было то, что файлы настройки сети были разбросаны по всей системе, частью настроек мог управлять *NetworkManager*, частью *systemd-networkd*, а часть вообще делалась с помощью *ifupdown*.

Новая система конфигурации позволяет таки сложить все яйца в одну корзину. Вы выполняете настройку в формате *YAML* (чувствителен к пробелам), а *Netplan* автоматически преобразовывает её при запуске в конфигурацию той системы, которую вы выбрали. В этой статье мы рассмотрим, как выполняется настройка сети *Netplan* в *Ubuntu*.


## Основы использования Netplan

Все конфигурационные файлы *Netplan* находятся в папке `/etc/netplan/`. Во время запуска службы, она преобразовывает свою конфигурацию в конфигурацию той службы, которая будет управлять сетью и помещает её в каталог `/run/`. По умолчанию в Ubuntu есть только один конфигурационный файл со следующим содержимым:
```bash
# Let NetworkManager manage all devices on this system
network: 
  version: 2
  renderer: NetworkManager 
```

Это означает, что управление всей сетью передаётся утилите NetworkManager. Чтобы разобраться, что это означает, давайте рассмотрим синтаксис конфигурационного файла. 

## 1. Синтаксис конфигурации Netplan

Новичкам синтаксис конфигурационного файла *Netplan* может показаться запутанным, но разобраться в нём вполне можно. Он чем-то напоминает *JSON*, но не имеет таких жёстких ограничений, однако, как замечено выше в скобках - основной минус этого языка в том что он очень чувствителен к пробелам.
```bash
поле0:
  поле1: значение
  поле2:
    - элемент1
    - элемент2
    - элемент3
```

Имя поля и его значение разделяется двоеточием. В качестве значения поля можно передавать не только текстовое или числовое значение, но и другое поле, несколько полей или список значений. При передаче списка каждый новый элемент списка должен начинаться с дефиса. Табуляции использовать нельзя. Отступы используются для указания структуры. Например, из примера видно, что `поле1` и `поле2` относятся к `полю0`. Это всё, что касается общего синтаксиса, теперь про Netplan:
```bash
network:
  version: 2
  renderer: программа_бэкенд
  вид_интерфейса:
    имя_интерфейса:
       параметр: значение
```

Первые две строчки конфигурации стандартны. Первая указывает, что мы будем иметь дело с сетью, а вторая указывает версию стандарта конфигурации, которая будет использоваться. Их лучше не трогать.

- **renderer** - указывает программу, для которой будут преобразоваться ваши настройки. На данный момент поддерживаются только *network-manager* и *systemd-networkd*;
- **вид_интерфейса** - вид сетевых интерфейсов, которые вы будете настраивать в этой секции. Они делятся на физические: `ethernets` (проводные), `wifis` (беспроводные) и виртуальные: `vlans` , `bonds`, `bridges`.
- **имя_интерфейса** - имя сетевого интерфейса в системе, например `enp3s0` или `eth0`;
- **параметры** - настройки, с помощью которых указывается, как нужно подключаться к сети.

[Назад к оглавлению](#оглавление)


## 2. Параметры Netplan

Мы разобрались с основным синтаксисом, далее разберём команды, с помощью которых мы будем настраивать сеть:

- **renderer** - программа для обработки конфигурации;
- **dhcp4** - получение IPv4 адреса по DHCP;
- **dhcp6** - получение IPv6 адреса по DHCP;
- **dhcp-identifier** - если передать значение "mac", то будет использоваться MAC-адрес в качестве идентификатора DHCP;
- **addresses** - добавляет статические адреса к интерфейсу, можно несколько;
- **gateway4** - указывает шлюз IPv4;
- **gateway6** - указывает шлюз IPv6;
- **nameservers** - указывает DNS-серверы;
- **macaddress** - устанавливает новый MAC-адрес;
- **routes** - позволяет настроить маршруты таблицы маршрутизации;
- **routing-policy** - дополнительная настройка маршрутов, для IP или подсети;
- **access-points** - список точек доступа для Wi-Fi;
- **password** - пароль для точки доступа Wi-Fi;
- **mode** - режим работы сетевой карты Wi-Fi.


## 3. Команды Netplan

Синтаксис самой команды *netplan* очень прост:
```bash
netplan опции команда
```

В качестве команды можно передать одну из команд:

- **try** - попробовать применить конфигурацию с возможностью отмены;
- **apply** - применить конфигурацию;
- **generate** - проверка текущей конфигурации и запись на диск;
- **config** - записать текущую конфигурацию сети в YAML.

[Назад к оглавлению](#оглавление)


# Как настроить сеть Netplan в Ubuntu

Сначала необходимо посмотреть, как называются сетевые интерфейсы в вашей системе. Для этого можно просто изучить содержимое папки `/sys/class/net`: 
```bash
admin_d@docker-station:~$ ls /sys/class/net
br-675eb9f25cd1  br-962e7d05b686  docker0  lo           veth5e17e97  vethd40c645
br-9486f36be6a5  br-e8f586795b21  ens160   veth2a88c37  veth90dcf54  vethd970531 
```

Здесь представлены интерфейсы `localhost` (`lo`) и проводной `Ethernet` интерфейс `ens160`. Так как из названия хоста (`docker-station`) видно, что на данной операционке запущены докер контейнеры, и устройства `docker0`, `br-675eb9f25cd1`,  `veth5e17e97` - ялвяются интерфейсами контейнеров. Все устройства, кроме `lo` - могут называться по разному.

## 1. Настройка динамического IP в Netplan

Для настройки динамического IP- адреса для интерфейса `ens160` создадим новый конфигурационный файл `02-networkd.yaml`. Самая простая настройка *Netplan* для получения IP по DHCP будет выглядеть вот так:
```bash
sudo vi /etc/netplan/02-networkd.yaml
```
```bash
network:
  version: 2
  renderer: networkd
  ethernets:
    ens160:
      dhcp4: yes
```

В качестве программы для обработки конфигурации мы используем `Networkd`, далее мы указываем наш сетевой интерфейс и включаем получение *IPv4* адреса по *DHCP*. Все остальные параметры тоже подтянутся по DHCP. Или мы можем вручную настроить *DNS* для этого интерфейса:
```bash
network:
  version: 2
  renderer: networkd
  ethernets:
    ens160:
      dhcp4: yes
      nameservers:
        - 8.8.8.8
        - 8.8.4.4
```

Теперь осталось проверить эту конфигурацию. Для этого выполните:
```bash
sudo netplan generate
```

Если ошибок нет, программа ничего не выведет и запишет вашу конфигурацию на диск. Если есть ошибки, утилита о них сообщит.

[Назад к оглавлению](#оглавление)


## 2. Настройка статического IP в Netplan

Статический IP-адрес в *Netplan* настроить немного сложнее. Поскольку здесь нам нужно будет задать не только непосредственно сам адрес, но и кучу других параметров, которые система раньше получала по DHCP. Нам надо указать *шлюз* для доступа в интернет и DNS-серверы. Модифицируем тот же конфигурационный файл:
```bash
sudo vi /etc/netplan/02-networkd.yaml
```
```bash
network:
  version: 2
  renderer: networkd
  ethernets:
    ens160:
      dhcp4: no
      addresses: [ 192.168.0.200/24 ]
      gateway4: 192.168.0.1
      nameservers:
        addresses: [ 8.8.8.8, 8.8.4.4 ] 
```

Рассмотрим подробнее, что за что отвечает в этом конфигурационном файле.

- **dhcp4** - отключаем получение IP адреса по DHCP;
- **addresses** - параметр ожидает список IP-адресов, которые нужно присвоить нашей сетевой карте, у нас только один адрес, однако, передавать его надо тоже в *формате списка*, иначе будет ошибка. В конце адреса указывается *префикс маски* - `/24`, который отвечает маске сети `255.255.255.0`. Вы можете указать и другую маску, но только с помощью префикса, отдельного параметра для этого нет.
- **gateway4** - задаёт адрес роутера (гейтвей - *gateway*), через который наш компьютер сможет получить доступ в интернет; 

Остальное вы знаете. Списки можно оформлять не только с помощью *черточек тире*, для каждого пункта с новой строки, но и с помощью квадратных скобок, тогда элементы записываются в *одну строку через запятую*.


## 3. Настройка маршрутов в Netplan

В *Netplan* можно настроить статический маршрут. Он задается для конкретного интерфейса, также в конфигурационном файле, например:
```bash
sudo vi /etc/netplan/02-networkd.yaml
```
```bash
network:
  version: 2
  renderer: networkd
  ethernets:
    ens160:
      dhcp4: no
      addresses: [ 192.168.0.200/24 ]
      nameservers:
        addresses: [ 8.8.8.8, 8.8.4.4 ] 
      routes:
        - to: 192.168.1.0/24
          via: 192.168.0.1
          on-link: true
        - to: 192.168.120.0/29
          via: 192.168.120.1
          on-link: true
```

В данном примере мы настроили маршрут для сетевого интерфейса `ens160`. Данная настройка задается параметром `routes`:

- `to` - направление маршрута (в какую сеть мы должны попадать). В данном примере, `192.168.1.0/24` и `192.168.120.0/29`
- `via` — через какой шлюз мы попадаем в сеть `to`.
- `on-link` — активация маршрута при поднятии линка на сетевом интерфейсе.

[Назад к оглавлению](#оглавление)


## 4. Настройка Wi-Fi через Netplan на Ubuntu

Кроме проводного подключения, система конфигурации *Netplan* умеет управлять подключением к Wi-Fi. Это отличная новость, учитывая, насколько сложно всё это раньше настраивалось, если не было `NetworkManager`. Правда, для работы *Wi-Fi* через `Networkd` надо, чтобы в системе был установлен пакет `wpasupplicant`. Например, у нас есть интерфейс `wlp3s0b1` и точка доступа *AccessPoint* с паролем *12345678* и мы хотим к ней подключаться. Тогда настройка `Netplan` Ubuntu будет выглядеть так:
```bash
sudo vi /etc/netplan/02-networkd.yaml
```
```bash
network:
  version: 2
  renderer: networkd
  wifis:
    wlp3s0b1:
      dhcp4: yes
      dhcp6: no
      nameservers:
          addresses: [ 8.8.8.8, 8.8.4.4 ]
      access-points:
        "AccessPoint"
          password: "12345678"
```

Здесь мы указываем, что надо получить IP и другие параметры по DHCP, устанавливаем DNS-сервер вручную, хотя это не обязательно, а затем добавляем точку доступа и пароль к ней.

## 5. Применение конфигурации netplan

Естественно, что после смены настроек в конфигурационном файле ничего не меняется. Сначала нужно проверить конфигурационный файл на ошибки и создать файлы конфигурации программы-обработчика. Для этого выполните:
```bash
sudo netplan generate
```

Если вы хотите видеть более подробную информацию, используйте опцию `--debug`:
```bash
sudo netplan --debug generate
```

Если есть ошибки, их надо исправить, если нет, применяем конфигурацию с помощью команды:
```bash
sudo netplan --debug apply
```

Если вы меняли программу-обработчик, например с `NetworkManager` на `networkd`, то надо ещё *перезапустить компьютер*. После этого сеть будет работать на новой конфигурации.

[Назад к оглавлению](#оглавление)


# Выводы

В этой статье мы рассмотрели, как выполняется настройка сети *Netplan* в *Ubuntu*. Как видите, это не очень сложно, и даже удобно, по сравнению со старой конфигурацией. Конечно, есть некоторые недостатки - та же самая невозможность задать маску без префикса, но программа активно развивается, возможно, в будущем это будет исправлено.